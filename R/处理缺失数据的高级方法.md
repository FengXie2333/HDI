# 处理缺失数据的高级方法

## 步骤

1 识别

2 找原因

3 合适的处理

&nbsp;

##  缺失数据的分类

**完全随机缺失**（MCAR）：与其他变量都不相关。可以认为完整数据是对整体数据集的随机抽样

**随机缺失**（MAR）：与其他观测变量有关，但与自己的未观测值无关   

如： 体重较小的动物其做梦时长的缺失较大，可能是因为体重小的动物难以观测。而此缺失与动物的做梦时长本身没有关系

**非随机缺失** （NMAR）

***大部分的缺失值处理方法都假定缺失数据是MCAR或MAR***

&nbsp;

##  图形探究缺失数据

~~~R
matrixplot(sleep, xlab = colnames(sleep))
~~~



`md.pattern()`生成一个以矩阵或数据框展示的缺失值的模式表格



`aggr()`绘制每个变量的缺失值数，和组合变量的缺失值数



`matrixplot`



`marginplot()`生成一个散点图

&nbsp;

## 用相关性探究缺失数据

~~~R
x <- as.data.frame(abs(is.na(sleep))) ##有缺失的值为1 无缺失为0
head(sleep, n=5)
head(x, n=5)
y <- x[which(apply(x,2,sum)>0)] ##提取含缺失值的变量
cor(y)  ##计算缺失变量之间的相关性
cor(sleep, y, use="pairwise.complete.obs") ##计算缺失与不缺失之间的相关性
~~~



![](https://i.loli.net/2018/09/13/5b9a1b80b4e62.jpg)

&nbsp;

##  缺失值的常用处理方法

**行删除法（大部分软件默认）**

`complete.cases()`   `na.omit`

&nbsp;

**推理法**

&nbsp;

**多重插补**

原理：多值插补的思想来源于贝叶斯估计，认为待插补的值是随机的，它的值来自于已观测到的值。具体实践上通常是估计出待插补的值，然后再加上不同的噪声，形成多组可选插补值。根据某种选择依据，选取最合适的插补值。缺失值通过蒙特卡洛方法填补。

![](https://i.loli.net/2018/09/13/5b9a2011dd285.jpg)

&nbsp;

***蒙特卡洛基本思想***：当所求解问题是某种随机事件出现的概率，或者是某个随机变量的期望值时，通过某种“实验”的方法，以这种事件出现的频率估计这一随机事件的概率，或者得到这个随机变量的某些数字特征，并将其作为问题的解。

工作过程

蒙特卡罗方法的解题过程可以归结为三个主要步骤：构造或描述概率过程；实现从已知概率分布抽样；建立各种估计量。

缺失值的插补通过Gibbs抽样完成。可以自主选择预测模型。

&nbsp;

使用`mice()`函数

![å¤çç¼ºå¤±å¼ä¹å¤éæè¡¥ï¼Multiple Imputationï¼](https://pic2.zhimg.com/v2-561283772be13543dee88df86a1afb85_1200x500.jpg)

&nbsp;

函数mice()首先从一个包含缺失数据的数据框开始，然后返回一个包含多个（默认为5个）完
整数据集的对象。每个完整数据集都是通过对原始数据框中的缺失数据进行插补而生成的。由于插
补有随机的成分，因此每个完整数据集都略有不同。然后，with()函数可依次对每个完整数据集
应用统计模型（如线性模型或广义线性模型），最 后 ，pool()函数将这些单独的分析结果整合为一
组结果。最终模型的标准误和p值都将准确地反映出由于缺失值和多重插补而产生的不确定性。

&nbsp;

~~~R
options(digits=3)
library(mice)
data(sleep, package="VIM")
imp <- mice(sleep, seed=1234)  ##m默认值为5，指有5个填补缺失值的预测值
fit <- with(imp, lm(Dream ~ Span + Gest)) #对5个数据集都做统计分析
pooled <- pool(fit) #将分析结果整合为一组
summary(pooled)
imp
~~~

&nbsp;

~~~R
imp$imp$Dream   ##提取imp对象的子成分，可以观测到实际的观测值
~~~

&nbsp;

 ~~~R
complete(imp, action=n) ##指定m个完整数据集中的一个来展示
 ~~~

&nbsp;

##  成对删除、简单插补

建议不要使用

